<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#FFDCC1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="CareTrack" />
  <title>CareTrack</title>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script type="text/babel">
const { useState, useEffect, useCallback, useMemo } = React;

// --- Firebase Setup ---

const firebaseConfig = {
  apiKey: "AIzaSyAJ19IL4Ey-WRph5sPhRRR6LNfChU4poXY",
  authDomain: "caretrackapp-3a238.firebaseapp.com",
  projectId: "caretrackapp-3a238",
  storageBucket: "caretrackapp-3a238.firebasestorage.app",
  messagingSenderId: "1035316963864",
  appId: "1:1035316963864:web:bfe52c81267a60d11e716d"
};

const fbApp = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const googleProvider = new firebase.auth.GoogleAuthProvider();

// --- Utilities -----------------------------------------------
const genId = () => Math.random().toString(36).slice(2, 10);
const today = () => new Date().toISOString().slice(0, 10);
const daysBetween = (a, b) => Math.round((new Date(b) - new Date(a)) / 86400000);
const addDays = (date, n) => {
  const d = new Date(date);
  d.setDate(d.getDate() + n);
  return d.toISOString().slice(0, 10);
};
const formatDate = (d) => {
  if (!d) return "‚Äî";
  const dt = new Date(d + "T00:00:00");
  return dt.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
};
const formatDateTime = (d, t) => {
  if (!d) return "‚Äî";
  let str = formatDate(d);
  if (t) str += ` at ${t}`;
  return str;
};
const isPast = (d) => d < today();
const daysFromNow = (d) => daysBetween(today(), d);
const fmtDate = formatDate;

// --- Storage (Firestore - syncs across devices) -----
const loadData = async (uid) => {
  try {
    const snap = await db.collection("users").doc(uid).get();
    return snap.exists ? snap.data() : null;
  } catch (e) { console.error("Load failed", e); return null; }
};
const saveData = async (data, uid) => {
  try {
    await db.collection("users").doc(uid).set(data);
  } catch (e) { console.error("Save failed", e); }
};
const groupBy = (arr, fn) => { const m = {}; arr.forEach((x) => { const k = fn(x); (m[k] = m[k] || []).push(x); }); return m; };
const formatDateShort = (d) => { if (!d) return "‚Äî"; return new Date(d + "T00:00:00").toLocaleDateString("en-US", { month: "short", day: "numeric" }); };

const DEFAULT_DATA = { people: [], medications: [], doctors: [], appointments: [], dismissed: [] };

const APPT_STATUSES = [
  { value: "scheduled", label: "Scheduled", color: "#4A7AB5", bg: "#E8F0F8" },
  { value: "completed", label: "Completed", color: "#4A8C3F", bg: "#E8F5E4" },
  { value: "canceled", label: "Canceled", color: "#A89494", bg: "#F0E8E0" },
  { value: "no_show", label: "No-Show", color: "#C0392B", bg: "#FEECEC" },
  { value: "waiting_reschedule", label: "Waiting to Reschedule", color: "#C77A20", bg: "#FFF3E0" },
  { value: "needs_update", label: "Needs Update", color: "#8E6BB0", bg: "#F3ECFA" },
];
const getStatusStyle = (s) => APPT_STATUSES.find((x) => x.value === s) || APPT_STATUSES[0];

// --- Icons ---------------------------------------------------
const I = {
  pill: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.5 1.5l-8 8a5 5 0 007 7l8-8a5 5 0 00-7-7z"/><path d="M6.5 10.5l4-4"/></svg>,
  people: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>,
  alert: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
  plus: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  edit: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
  trash: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/></svg>,
  home: <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
  heart: <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>,
  clock: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
  doctor: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 21h18"/><path d="M9 8h1"/><path d="M14 8h1"/><path d="M9 12h1"/><path d="M14 12h1"/><path d="M5 21V5a2 2 0 012-2h10a2 2 0 012 2v16"/></svg>,
  calendar: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
  phone: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>,
  mail: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>,
  map: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>,
  fax: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/><line x1="10" y1="12" x2="10" y2="12.01"/><line x1="14" y1="12" x2="14" y2="12.01"/></svg>,
  refresh: <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>,
  bell: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>,
  report: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>,
};

// --- CSS -----------------------------------------------------
const STYLES = `
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&family=Lora:wght@400;500;600&display=swap');
  :root {
    --cream:#FFF8F0;--warm-white:#FFFDFB;--peach:#FFE8D6;--peach-mid:#FFDCC1;
    --coral:#E8927C;--coral-deep:#D4735C;--sage:#A8C5A0;--sage-deep:#7BA872;
    --sky:#9DC4D4;--sky-deep:#6FA3B7;--lavender:#C5B3D6;--amber:#F0C27A;--amber-deep:#D4A24C;
    --text-primary:#3D2E2E;--text-secondary:#7A6565;--text-muted:#A89494;
    --border:#F0DED0;--border-focus:#E8927C;
    --shadow-sm:0 1px 3px rgba(61,46,46,0.06);--shadow-md:0 4px 12px rgba(61,46,46,0.08);
    --shadow-lg:0 8px 24px rgba(61,46,46,0.1);--radius:16px;--radius-sm:10px;--radius-xs:6px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Nunito',sans-serif;background:var(--cream);color:var(--text-primary);-webkit-font-smoothing:antialiased}
  .app{max-width:480px;margin:0 auto;min-height:100vh;background:var(--warm-white);position:relative;overflow-x:hidden}

  .header{background:linear-gradient(135deg,#FFE8D6 0%,#FFDCC1 50%,#F5D0B8 100%);padding:20px 20px 24px;position:relative;overflow:hidden}
  .header::before{content:'';position:absolute;top:-30px;right:-30px;width:120px;height:120px;background:rgba(255,255,255,0.25);border-radius:50%}
  .header::after{content:'';position:absolute;bottom:-20px;left:40px;width:80px;height:80px;background:rgba(255,255,255,0.15);border-radius:50%}
  .header-top{display:flex;align-items:center;justify-content:space-between;position:relative;z-index:1}
  .header h1{font-family:'Lora',serif;font-size:22px;font-weight:600;color:var(--text-primary)}
  .header-subtitle{font-size:13px;color:var(--text-secondary);margin-top:2px;position:relative;z-index:1}
  .header-heart{color:var(--coral);opacity:0.7;animation:pulse 2s ease-in-out infinite}
  .header-bell{position:relative;background:rgba(255,255,255,0.5);border:none;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--coral-deep);transition:all 0.2s;z-index:1}
  .header-bell:hover{background:rgba(255,255,255,0.8)}
  .header-bell-badge{position:absolute;top:-2px;right:-2px;background:#E85D4A;color:white;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 4px;font-family:'Nunito',sans-serif}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}

  .cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  .cal-title{font-family:'Lora',serif;font-size:18px;font-weight:600}
  .cal-nav{display:flex;gap:6px}
  .cal-nav button{width:32px;height:32px;border:1.5px solid var(--border);border-radius:50%;background:var(--warm-white);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);font-size:16px;transition:all 0.15s}
  .cal-nav button:hover{background:var(--peach);border-color:var(--peach-mid)}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:16px}
  .cal-dow{text-align:center;font-size:10px;font-weight:700;color:var(--text-muted);padding:6px 0;text-transform:uppercase}
  .cal-day{position:relative;min-height:48px;padding:4px;border-radius:8px;cursor:pointer;transition:all 0.15s;border:1.5px solid transparent}
  .cal-day:hover{background:var(--peach);border-color:var(--peach-mid)}
  .cal-day.today{border-color:var(--coral);background:#FFF5EE}
  .cal-day.selected{border-color:var(--coral);background:#FFE8D6}
  .cal-day.other-month{opacity:0.35}
  .cal-day-num{font-size:12px;font-weight:700;color:var(--text-primary);margin-bottom:2px}
  .cal-day.today .cal-day-num{color:var(--coral-deep)}
  .cal-dots{display:flex;gap:2px;flex-wrap:wrap}
  .cal-dot{width:6px;height:6px;border-radius:50%}
  .cal-day-detail{margin-top:12px}

  .nav-tabs{display:flex;gap:2px;padding:10px 12px;background:var(--warm-white);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
  .nav-tab{flex:1;display:flex;align-items:center;justify-content:center;gap:4px;padding:9px 4px;border:none;background:transparent;border-radius:var(--radius-sm);font-family:'Nunito',sans-serif;font-size:11px;font-weight:700;color:var(--text-muted);cursor:pointer;transition:all 0.2s ease;white-space:nowrap}
  .nav-tab:hover{background:var(--peach);color:var(--text-secondary)}
  .nav-tab.active{background:var(--coral);color:white;box-shadow:0 2px 8px rgba(232,146,124,0.3)}
  .nav-badge{background:#E85D4A;color:white;font-size:9px;font-weight:700;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 4px;margin-left:2px}

  .content{padding:16px;padding-bottom:100px}

  .card{background:var(--warm-white);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px;box-shadow:var(--shadow-sm);transition:all 0.2s ease}
  .card:hover{box-shadow:var(--shadow-md);border-color:var(--peach-mid)}
  .card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px}
  .card-title{font-weight:700;font-size:16px;color:var(--text-primary)}
  .card-subtitle{font-size:13px;color:var(--text-secondary);margin-top:2px}
  .card-actions{display:flex;gap:4px}
  .card-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:0.3px}
  .badge-ok{background:#E8F5E4;color:#4A8C3F}.badge-warn{background:#FFF3E0;color:#C77A20}
  .badge-danger{background:#FEECEC;color:#C0392B}.badge-info{background:#E8F0F8;color:#4A7AB5}
  .badge-muted{background:#F0E8E0;color:var(--text-muted)}.badge-asneeded{background:#F3ECFA;color:#8E6BB0}
  .card-details{display:flex;flex-wrap:wrap;gap:6px 16px;margin-top:10px;font-size:13px;color:var(--text-secondary)}
  .card-detail{display:flex;align-items:center;gap:4px}

  .supply-bar-container{margin-top:12px}
  .supply-bar-label{display:flex;justify-content:space-between;font-size:12px;color:var(--text-secondary);margin-bottom:4px}
  .supply-bar{height:8px;background:#F0E8E0;border-radius:4px;overflow:hidden}
  .supply-bar-fill{height:100%;border-radius:4px;transition:width 0.5s ease}

  .alerts-section{margin-bottom:16px}
  .alert-card{background:linear-gradient(135deg,#FFF3E0 0%,#FEECEC 100%);border:1px solid #F5D0B8;border-radius:var(--radius);padding:14px 16px;margin-bottom:8px;display:flex;align-items:flex-start;gap:12px}
  .alert-icon{color:var(--coral-deep);flex-shrink:0;margin-top:1px}
  .alert-content{flex:1}
  .alert-title{font-weight:700;font-size:14px;color:var(--coral-deep)}
  .alert-text{font-size:13px;color:var(--text-secondary);margin-top:2px}
  .alert-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 18px;border:none;border-radius:var(--radius-sm);font-family:'Nunito',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s ease}
  .btn-primary{background:var(--coral);color:white;box-shadow:0 2px 8px rgba(232,146,124,0.3)}
  .btn-primary:hover{background:var(--coral-deep);box-shadow:0 4px 12px rgba(232,146,124,0.4);transform:translateY(-1px)}
  .btn-secondary{background:var(--peach);color:var(--coral-deep)}
  .btn-secondary:hover{background:var(--peach-mid)}
  .btn-ghost{background:transparent;color:var(--text-secondary);padding:8px}
  .btn-ghost:hover{background:var(--peach);color:var(--coral-deep)}
  .btn-danger{background:#FEECEC;color:#C0392B}.btn-danger:hover{background:#FCD5D5}
  .btn-sm{padding:6px 12px;font-size:12px}.btn-xs{padding:4px 10px;font-size:11px}
  .btn-full{width:100%}
  .fab{position:fixed;bottom:24px;right:calc(50% - 220px);width:56px;height:56px;border-radius:50%;background:var(--coral);color:white;border:none;box-shadow:0 4px 16px rgba(232,146,124,0.4);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s ease;z-index:20}
  .fab:hover{transform:scale(1.08);box-shadow:0 6px 20px rgba(232,146,124,0.5)}
  @media(max-width:520px){.fab{right:20px}}

  .form-group{margin-bottom:16px}
  .form-label{display:block;font-size:12px;font-weight:700;color:var(--text-secondary);margin-bottom:5px;text-transform:uppercase;letter-spacing:0.5px}
  .form-input,.form-select,.form-textarea{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:'Nunito',sans-serif;font-size:15px;color:var(--text-primary);background:var(--warm-white);transition:border-color 0.2s ease,box-shadow 0.2s ease;outline:none}
  .form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--coral);box-shadow:0 0 0 3px rgba(232,146,124,0.15)}
  .form-textarea{resize:vertical;min-height:70px}
  .form-row{display:flex;gap:12px}.form-row>.form-group{flex:1}

  .toggle-wrap{display:flex;align-items:center;gap:10px;cursor:pointer}
  .toggle-track{width:44px;height:24px;background:#D5C5B5;border-radius:12px;position:relative;transition:background 0.2s ease;flex-shrink:0}
  .toggle-track.on{background:var(--sage)}
  .toggle-knob{width:20px;height:20px;background:white;border-radius:50%;position:absolute;top:2px;left:2px;transition:transform 0.2s ease;box-shadow:0 1px 3px rgba(0,0,0,0.15)}
  .toggle-track.on .toggle-knob{transform:translateX(20px)}

  .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .section-title{font-family:'Lora',serif;font-size:18px;font-weight:600;color:var(--text-primary)}
  .section-count{font-size:12px;color:var(--text-muted);font-weight:600}

  .empty-state{text-align:center;padding:40px 20px}
  .empty-icon{width:80px;height:80px;margin:0 auto 16px;background:var(--peach);border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--coral)}
  .empty-title{font-family:'Lora',serif;font-size:18px;font-weight:600;margin-bottom:6px}
  .empty-text{font-size:14px;color:var(--text-secondary);margin-bottom:20px}

  .person-pills{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
  .person-pill{display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:20px;border:1.5px solid var(--border);background:var(--warm-white);font-family:'Nunito',sans-serif;font-size:13px;font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all 0.2s ease}
  .person-pill.active{border-color:var(--coral);background:#FFF0E8;color:var(--coral-deep)}
  .person-pill:hover{border-color:var(--peach-mid)}

  .overlay{position:fixed;inset:0;background:rgba(61,46,46,0.3);z-index:100;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn 0.2s ease}
  .modal{background:var(--warm-white);border-radius:20px 20px 0 0;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;animation:slideUp 0.3s ease}
  .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--warm-white);z-index:1;border-radius:20px 20px 0 0}
  .modal-title{font-family:'Lora',serif;font-size:18px;font-weight:600}
  .modal-body{padding:20px}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}

  .confirm-dialog{position:fixed;inset:0;background:rgba(61,46,46,0.4);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.2s ease}
  .confirm-box{background:var(--warm-white);border-radius:var(--radius);padding:24px;max-width:360px;width:100%;box-shadow:var(--shadow-lg);text-align:center}
  .confirm-box h3{font-family:'Lora',serif;margin-bottom:8px}
  .confirm-box p{font-size:14px;color:var(--text-secondary);margin-bottom:20px}
  .confirm-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

  /* Doctor business card */
  .dr-card{background:linear-gradient(135deg,var(--warm-white) 0%,#FFF5EE 100%);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px;box-shadow:var(--shadow-sm);position:relative;overflow:hidden}
  .dr-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--sky) 0%,var(--sage) 50%,var(--lavender) 100%)}
  .dr-card .dr-name{font-family:'Lora',serif;font-size:17px;font-weight:600;margin-top:4px}
  .dr-card .dr-specialty{font-size:13px;color:var(--sky-deep);font-weight:600;margin-top:2px}
  .dr-card .dr-clinic{font-size:13px;color:var(--text-secondary);font-style:italic}
  .dr-info{display:flex;flex-direction:column;gap:6px;margin-top:12px}
  .dr-info-row{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-secondary)}
  .dr-info-row svg{color:var(--coral);flex-shrink:0}
  .dr-appt-summary{margin-top:12px;padding-top:12px;border-top:1px dashed var(--border)}
  .dr-appt-line{font-size:12px;color:var(--text-muted);display:flex;justify-content:space-between;margin-bottom:3px}
  .dr-appt-line strong{color:var(--text-secondary)}

  /* Appointment card */
  .appt-card{border-left:4px solid;padding-left:14px}

  .reminder-card{border-radius:var(--radius);padding:14px 16px;margin-bottom:8px;display:flex;align-items:flex-start;gap:12px;position:relative;overflow:hidden}
  .reminder-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px}
  .r-danger{background:linear-gradient(135deg,#FEECEC,#FFF5F5)}.r-danger::before{background:#C0392B}
  .r-warn{background:linear-gradient(135deg,#FFF3E0,#FFFAF5)}.r-warn::before{background:#C77A20}
  .r-info{background:linear-gradient(135deg,#E8F0F8,#F5F8FC)}.r-info::before{background:#4A7AB5}
  .r-annual{background:linear-gradient(135deg,#F3ECFA,#FAF7FD)}.r-annual::before{background:#8E6BB0}
  .r-inventory{background:linear-gradient(135deg,#E8F5E4,#F5FAF3)}.r-inventory::before{background:#4A8C3F}
  .reminder-body{flex:1;min-width:0}.reminder-title{font-weight:700;font-size:14px;margin-bottom:2px}
  .reminder-text{font-size:13px;color:var(--text-secondary)}.reminder-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}

  .report-summary{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
  .report-stat{background:var(--warm-white);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center}
  .report-stat-num{font-size:22px;font-weight:800}.report-stat-label{font-size:11px;color:var(--text-muted);font-weight:600;margin-top:2px}
  .report-group{margin-bottom:16px}
  .report-group-header{font-family:'Lora',serif;font-size:15px;font-weight:600;padding:8px 0;border-bottom:1px solid var(--border);margin-bottom:8px;display:flex;justify-content:space-between}
  .report-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-sm);margin-bottom:4px;font-size:13px;background:var(--warm-white);border:1px solid var(--border)}
  .report-row-time{font-weight:700;color:var(--text-primary);min-width:60px;flex-shrink:0;font-size:12px}
  .report-row-info{flex:1;min-width:0}.report-row-status{flex-shrink:0}

  .login-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:40px 20px;text-align:center;background:linear-gradient(180deg,#FFF8F0 0%,#FFE8D6 50%,#FFDCC1 100%)}
  .login-title{font-family:'Lora',serif;font-size:32px;font-weight:600;color:var(--text-primary);margin-bottom:4px}
  .login-sub{font-size:15px;color:var(--text-secondary);margin-bottom:40px}
  .login-btn{display:flex;align-items:center;gap:12px;padding:14px 28px;border:2px solid var(--border);border-radius:50px;background:white;font-family:'Nunito',sans-serif;font-size:16px;font-weight:700;color:var(--text-primary);cursor:pointer;box-shadow:var(--shadow-md);transition:all 0.2s}
  .login-btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg);border-color:var(--coral)}
  .login-btn svg{flex-shrink:0}
  .user-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:rgba(255,255,255,0.5);border-bottom:1px solid var(--border);font-size:12px;color:var(--text-secondary)}
  .user-bar-info{display:flex;align-items:center;gap:8px}
  .user-avatar{width:24px;height:24px;border-radius:50%;object-fit:cover}
  .appt-status-badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700}

  ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--peach-mid);border-radius:2px}
`;

// --- Shared UI -----------------------------------------------
const Toggle = ({ value, onChange, label }) => (
  <label className="toggle-wrap" onClick={() => onChange(!value)}>
    <div className={`toggle-track ${value ? "on" : ""}`}><div className="toggle-knob" /></div>
    <span style={{ fontSize: 14, fontWeight: 600 }}>{label}</span>
  </label>
);

const Confirm = ({ title, message, onConfirm, onCancel, confirmLabel = "Delete", danger = true }) => (
  <div className="confirm-dialog" onClick={onCancel}>
    <div className="confirm-box" onClick={(e) => e.stopPropagation()}>
      <h3>{title}</h3><p>{message}</p>
      <div className="confirm-actions">
        <button className="btn btn-secondary" onClick={onCancel}>Cancel</button>
        <button className={`btn ${danger ? "btn-danger" : "btn-primary"}`} onClick={onConfirm}>{confirmLabel}</button>
      </div>
    </div>
  </div>
);

const Modal = ({ title, onClose, children }) => (
  <div className="overlay" onClick={onClose}>
    <div className="modal" onClick={(e) => e.stopPropagation()}>
      <div className="modal-header">
        <span className="modal-title">{title}</span>
        <button className="btn btn-ghost" onClick={onClose}>‚úï</button>
      </div>
      <div className="modal-body">{children}</div>
    </div>
  </div>
);

// --- Person Form ---------------------------------------------
function PersonForm({ person, onSave, onClose }) {
  const [name, setName] = useState(person?.name || "");
  const [relationship, setRelationship] = useState(person?.relationship || "");
  const [notes, setNotes] = useState(person?.notes || "");
  const save = () => { if (name.trim()) onSave({ id: person?.id || genId(), name: name.trim(), relationship: relationship.trim(), notes: notes.trim() }); };
  return (
    <Modal title={person ? "Edit Person" : "Add Person"} onClose={onClose}>
      <div className="form-group"><label className="form-label">Name *</label><input className="form-input" value={name} onChange={(e) => setName(e.target.value)} placeholder="e.g., Mom, Dad" autoFocus /></div>
      <div className="form-group"><label className="form-label">Relationship</label><input className="form-input" value={relationship} onChange={(e) => setRelationship(e.target.value)} placeholder="e.g., Mother, Self" /></div>
      <div className="form-group"><label className="form-label">Notes</label><textarea className="form-textarea" value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="Any helpful notes..." /></div>
      <button className="btn btn-primary btn-full" onClick={save} disabled={!name.trim()}>{person ? "Save Changes" : "Add Person"}</button>
    </Modal>
  );
}

// --- Medication Form -----------------------------------------
function MedForm({ med, people, doctors, onSave, onClose }) {
  const [f, setF] = useState({
    personId: med?.personId || (people.length === 1 ? people[0].id : ""),
    name: med?.name || "", strength: med?.strength || "", instructions: med?.instructions || "",
    frequency: med?.frequency || "scheduled", dosePerIntake: med?.dosePerIntake || "1",
    intakesPerDay: med?.intakesPerDay || "1", currentCount: med?.currentCount ?? "",
    lastRefillDate: med?.lastRefillDate || "", lastRefillQty: med?.lastRefillQty ?? "",
    refillBuffer: med?.refillBuffer ?? 7, lowThreshold: med?.lowThreshold ?? 3,
    doctorId: med?.doctorId || "", pharmacy: med?.pharmacy || "", purpose: med?.purpose || "",
    active: med?.active ?? true,
  });
  const s = (k, v) => setF((p) => ({ ...p, [k]: v }));
  const save = () => {
    if (!f.name.trim() || !f.personId) return;
    onSave({
      id: med?.id || genId(), ...f, name: f.name.trim(),
      dosePerIntake: parseFloat(f.dosePerIntake) || 1, intakesPerDay: parseFloat(f.intakesPerDay) || 1,
      currentCount: f.currentCount === "" ? null : parseFloat(f.currentCount),
      lastRefillQty: f.lastRefillQty === "" ? null : parseFloat(f.lastRefillQty),
      refillBuffer: parseInt(f.refillBuffer) || 7, lowThreshold: parseInt(f.lowThreshold) || 3,
    });
  };
  return (
    <Modal title={med ? "Edit Medication" : "Add Medication"} onClose={onClose}>
      {people.length > 1 && <div className="form-group"><label className="form-label">Person *</label><select className="form-select" value={f.personId} onChange={(e) => s("personId", e.target.value)}><option value="">Select person...</option>{people.map((p) => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div>}
      <div className="form-group"><label className="form-label">Medication Name *</label><input className="form-input" value={f.name} onChange={(e) => s("name", e.target.value)} placeholder="e.g., Metformin" autoFocus /></div>
      <div className="form-row">
        <div className="form-group"><label className="form-label">Strength</label><input className="form-input" value={f.strength} onChange={(e) => s("strength", e.target.value)} placeholder="e.g., 500mg" /></div>
        <div className="form-group"><label className="form-label">Frequency</label><select className="form-select" value={f.frequency} onChange={(e) => s("frequency", e.target.value)}><option value="scheduled">Scheduled</option><option value="as_needed">As Needed</option></select></div>
      </div>
      {f.frequency === "scheduled" && <div className="form-row">
        <div className="form-group"><label className="form-label">Dose / intake</label><input className="form-input" type="number" min="0.5" step="0.5" value={f.dosePerIntake} onChange={(e) => s("dosePerIntake", e.target.value)} /></div>
        <div className="form-group"><label className="form-label">Intakes / day</label><input className="form-input" type="number" min="1" step="1" value={f.intakesPerDay} onChange={(e) => s("intakesPerDay", e.target.value)} /></div>
      </div>}
      <div className="form-row">
        <div className="form-group"><label className="form-label">Pill count</label><input className="form-input" type="number" min="0" value={f.currentCount} onChange={(e) => s("currentCount", e.target.value)} placeholder="e.g., 60" /></div>
        <div className="form-group"><label className="form-label">Last refill qty</label><input className="form-input" type="number" min="0" value={f.lastRefillQty} onChange={(e) => s("lastRefillQty", e.target.value)} placeholder="e.g., 90" /></div>
      </div>
      <div className="form-group"><label className="form-label">Last refill date</label><input className="form-input" type="date" value={f.lastRefillDate} onChange={(e) => s("lastRefillDate", e.target.value)} /></div>
      {f.frequency === "scheduled" && <div className="form-row">
        <div className="form-group"><label className="form-label">Refill buffer (days)</label><input className="form-input" type="number" min="1" value={f.refillBuffer} onChange={(e) => s("refillBuffer", e.target.value)} /></div>
        <div className="form-group"><label className="form-label">Low supply (days)</label><input className="form-input" type="number" min="1" value={f.lowThreshold} onChange={(e) => s("lowThreshold", e.target.value)} /></div>
      </div>}
      {doctors.length > 0 && <div className="form-group"><label className="form-label">Prescribing Doctor</label><select className="form-select" value={f.doctorId} onChange={(e) => s("doctorId", e.target.value)}><option value="">None</option>{doctors.map((d) => <option key={d.id} value={d.id}>{d.name}{d.specialty ? ` ‚Äî ${d.specialty}` : ""}</option>)}</select></div>}
      <div className="form-group"><label className="form-label">Purpose</label><input className="form-input" value={f.purpose} onChange={(e) => s("purpose", e.target.value)} placeholder="What it's for..." /></div>
      <div className="form-group"><label className="form-label">Instructions</label><textarea className="form-textarea" value={f.instructions} onChange={(e) => s("instructions", e.target.value)} placeholder="e.g., Take with food" /></div>
      <div className="form-group"><label className="form-label">Pharmacy</label><input className="form-input" value={f.pharmacy} onChange={(e) => s("pharmacy", e.target.value)} placeholder="e.g., CVS on Main St" /></div>
      <div className="form-group" style={{ marginTop: 8 }}><Toggle value={f.active} onChange={(v) => s("active", v)} label={f.active ? "Active" : "Inactive"} /></div>
      <button className="btn btn-primary btn-full" onClick={save} disabled={!f.name.trim() || !f.personId} style={{ marginTop: 12 }}>{med ? "Save Changes" : "Add Medication"}</button>
    </Modal>
  );
}

// --- Doctor Form ---------------------------------------------
function DoctorForm({ doctor, people, onSave, onClose }) {
  const [f, setF] = useState({
    name: doctor?.name || "", specialty: doctor?.specialty || "", clinic: doctor?.clinic || "",
    phone: doctor?.phone || "", fax: doctor?.fax || "", email: doctor?.email || "",
    address: doctor?.address || "", notes: doctor?.notes || "",
    personIds: doctor?.personIds || [],
  });
  const s = (k, v) => setF((p) => ({ ...p, [k]: v }));
  const togglePerson = (pid) => {
    setF((p) => ({ ...p, personIds: p.personIds.includes(pid) ? p.personIds.filter((x) => x !== pid) : [...p.personIds, pid] }));
  };
  const save = () => { if (f.name.trim()) onSave({ id: doctor?.id || genId(), ...f, name: f.name.trim() }); };
  return (
    <Modal title={doctor ? "Edit Doctor" : "Add Doctor"} onClose={onClose}>
      <div className="form-group"><label className="form-label">Doctor Name *</label><input className="form-input" value={f.name} onChange={(e) => s("name", e.target.value)} placeholder="e.g., Dr. Sarah Johnson" autoFocus /></div>
      {people.length > 0 && (
        <div className="form-group">
          <label className="form-label">Patients</label>
          <div className="person-pills" style={{ marginBottom: 0 }}>
            {people.map((p) => (
              <button key={p.id} type="button" className={`person-pill ${f.personIds.includes(p.id) ? "active" : ""}`} onClick={() => togglePerson(p.id)}>{p.name}</button>
            ))}
          </div>
          <div style={{ fontSize: 11, color: "var(--text-muted)", marginTop: 4 }}>Tap to select who sees this doctor</div>
        </div>
      )}
      <div className="form-row">
        <div className="form-group"><label className="form-label">Specialty</label><input className="form-input" value={f.specialty} onChange={(e) => s("specialty", e.target.value)} placeholder="e.g., Cardiology" /></div>
        <div className="form-group"><label className="form-label">Clinic</label><input className="form-input" value={f.clinic} onChange={(e) => s("clinic", e.target.value)} placeholder="e.g., City Health" /></div>
      </div>
      <div className="form-row">
        <div className="form-group"><label className="form-label">Phone</label><input className="form-input" value={f.phone} onChange={(e) => s("phone", e.target.value)} placeholder="(555) 123-4567" /></div>
        <div className="form-group"><label className="form-label">Fax</label><input className="form-input" value={f.fax} onChange={(e) => s("fax", e.target.value)} placeholder="(555) 123-4568" /></div>
      </div>
      <div className="form-group"><label className="form-label">Email</label><input className="form-input" value={f.email} onChange={(e) => s("email", e.target.value)} placeholder="doctor@clinic.com" /></div>
      <div className="form-group"><label className="form-label">Address</label><input className="form-input" value={f.address} onChange={(e) => s("address", e.target.value)} placeholder="123 Medical Way, Suite 100" /></div>
      <div className="form-group"><label className="form-label">Notes</label><textarea className="form-textarea" value={f.notes} onChange={(e) => s("notes", e.target.value)} placeholder="Any notes about this doctor..." /></div>
      <button className="btn btn-primary btn-full" onClick={save} disabled={!f.name.trim()} style={{ marginTop: 8 }}>{doctor ? "Save Changes" : "Add Doctor"}</button>
    </Modal>
  );
}

// --- Appointment Form ----------------------------------------
function ApptForm({ appt, people, doctors, onSave, onClose }) {
  const [f, setF] = useState({
    personId: appt?.personId || (people.length === 1 ? people[0].id : ""),
    doctorId: appt?.doctorId || "",
    date: appt?.date || "", time: appt?.time || "",
    status: appt?.status || "scheduled", reason: appt?.reason || "", notes: appt?.notes || "",
    linkedApptId: appt?.linkedApptId || "",
  });
  const s = (k, v) => setF((p) => ({ ...p, [k]: v }));
  // Filter doctors: show ones assigned to selected person first, then others
  const assignedDocs = f.personId ? doctors.filter((d) => (d.personIds || []).includes(f.personId)) : [];
  const otherDocs = f.personId ? doctors.filter((d) => !(d.personIds || []).includes(f.personId)) : doctors;
  const save = () => { if (f.personId && f.doctorId && f.date) onSave({ id: appt?.id || genId(), ...f }); };
  return (
    <Modal title={appt ? "Edit Appointment" : "New Appointment"} onClose={onClose}>
      <div className="form-group"><label className="form-label">Person *</label><select className="form-select" value={f.personId} onChange={(e) => { s("personId", e.target.value); s("doctorId", ""); }}><option value="">Select person...</option>{people.map((p) => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div>
      <div className="form-group"><label className="form-label">Doctor *</label>
        <select className="form-select" value={f.doctorId} onChange={(e) => s("doctorId", e.target.value)}>
          <option value="">Select doctor...</option>
          {assignedDocs.length > 0 && <optgroup label={`${people.find((p) => p.id === f.personId)?.name || "Their"}'s Doctors`}>
            {assignedDocs.map((d) => <option key={d.id} value={d.id}>{d.name}{d.specialty ? ` ‚Äî ${d.specialty}` : ""}</option>)}
          </optgroup>}
          {otherDocs.length > 0 && <optgroup label={assignedDocs.length > 0 ? "Other Doctors" : "All Doctors"}>
            {otherDocs.map((d) => <option key={d.id} value={d.id}>{d.name}{d.specialty ? ` ‚Äî ${d.specialty}` : ""}</option>)}
          </optgroup>}
        </select>
      </div>
      <div className="form-row">
        <div className="form-group"><label className="form-label">Date *</label><input className="form-input" type="date" value={f.date} onChange={(e) => s("date", e.target.value)} /></div>
        <div className="form-group"><label className="form-label">Time</label><input className="form-input" type="time" value={f.time} onChange={(e) => s("time", e.target.value)} /></div>
      </div>
      <div className="form-group"><label className="form-label">Status</label>
        <select className="form-select" value={f.status} onChange={(e) => s("status", e.target.value)}>
          {APPT_STATUSES.map((st) => <option key={st.value} value={st.value}>{st.label}</option>)}
        </select>
      </div>
      <div className="form-group"><label className="form-label">Reason</label><input className="form-input" value={f.reason} onChange={(e) => s("reason", e.target.value)} placeholder="e.g., Annual checkup" /></div>
      <div className="form-group"><label className="form-label">Notes</label><textarea className="form-textarea" value={f.notes} onChange={(e) => s("notes", e.target.value)} placeholder="Any notes..." /></div>
      <button className="btn btn-primary btn-full" onClick={save} disabled={!f.personId || !f.doctorId || !f.date} style={{ marginTop: 8 }}>{appt ? "Save Changes" : "Schedule Appointment"}</button>
    </Modal>
  );
}

// --- Appointment Update Prompt Modal -------------------------
function ApptUpdatePrompt({ appt, personName, doctorName, onAction, onClose }) {
  return (
    <Modal title="Update Appointment" onClose={onClose}>
      <p style={{ fontSize: 14, color: "var(--text-secondary)", marginBottom: 16 }}>
        The appointment for <strong>{personName}</strong> with <strong>{doctorName}</strong> on <strong>{formatDate(appt.date)}</strong> hasn't been updated. What happened?
      </p>
      <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
        <button className="btn btn-primary btn-full" onClick={() => onAction("completed")}>‚úÖ Attended ‚Äî Mark Completed</button>
        <button className="btn btn-secondary btn-full" onClick={() => onAction("waiting_reschedule")}>üîÑ Needs Rescheduling</button>
        <button className="btn btn-secondary btn-full" onClick={() => onAction("reschedule_new")}>üìÖ Already Rescheduled ‚Äî Add New</button>
        <button className="btn btn-danger btn-full" onClick={() => onAction("no_show")}>‚ùå No-Show</button>
      </div>
    </Modal>
  );
}

// --- Count Update Modal --------------------------------------
function CountModal({ med, mode, onSave, onClose }) {
  const [value, setValue] = useState(mode === "refill" ? (med.lastRefillQty || "90") : String(med.currentCount || 0));
  const save = () => {
    const n = parseFloat(value);
    if (isNaN(n) || n < 0) return;
    if (mode === "refill") onSave({ ...med, currentCount: (med.currentCount || 0) + n, lastRefillDate: today(), lastRefillQty: n });
    else onSave({ ...med, currentCount: n });
  };
  return (
    <Modal title={`${mode === "refill" ? "Log Refill" : "Adjust Count"} ‚Äî ${med.name}`} onClose={onClose}>
      <div className="form-group"><label className="form-label">{mode === "refill" ? "Quantity received" : "Current pill count"}</label><input className="form-input" type="number" min="0" value={value} onChange={(e) => setValue(e.target.value)} autoFocus /></div>
      {mode === "refill" && <p style={{ fontSize: 13, color: "var(--text-secondary)", marginBottom: 16 }}>Current ({med.currentCount || 0}) + refill ({value || 0}) = <strong>{(med.currentCount || 0) + (parseFloat(value) || 0)}</strong></p>}
      <button className="btn btn-primary btn-full" onClick={save}>Save</button>
    </Modal>
  );
}

// --- Medication Card -----------------------------------------
function MedCard({ med, personName, onEdit, onUpdateCount }) {
  const isScheduled = med.frequency === "scheduled";
  const dailyUsage = isScheduled ? (med.dosePerIntake || 1) * (med.intakesPerDay || 1) : null;
  const hasCount = med.currentCount != null && med.currentCount !== "";
  let daysLeft = null, runOutDate = null, refillCheckDate = null, supplyPct = 100;
  if (isScheduled && hasCount && dailyUsage > 0) {
    daysLeft = Math.floor(med.currentCount / dailyUsage);
    runOutDate = addDays(today(), daysLeft);
    refillCheckDate = addDays(today(), daysLeft - (med.refillBuffer || 7));
    supplyPct = Math.min(100, Math.round((med.currentCount / (med.lastRefillQty || med.currentCount)) * 100));
  }
  const isLow = daysLeft !== null && daysLeft <= (med.lowThreshold || 3);
  const needsRefill = daysLeft !== null && daysLeft <= (med.refillBuffer || 7);
  let badge;
  if (!med.active) badge = <span className="card-badge badge-muted">Inactive</span>;
  else if (!isScheduled) badge = <span className="card-badge badge-asneeded">As Needed</span>;
  else if (isLow) badge = <span className="card-badge badge-danger">{I.alert} Low</span>;
  else if (needsRefill) badge = <span className="card-badge badge-warn">Refill Soon</span>;
  else badge = <span className="card-badge badge-ok">Good</span>;
  const barColor = isLow ? "#C0392B" : needsRefill ? "#C77A20" : "#4A8C3F";
  return (
    <div className="card" style={{ opacity: med.active ? 1 : 0.6 }}>
      <div className="card-header">
        <div><div className="card-title">{med.name} {med.strength && <span style={{ fontWeight: 500, color: "var(--text-secondary)", fontSize: 14 }}>{med.strength}</span>}</div><div className="card-subtitle">for {personName}</div></div>
        <div className="card-actions">{badge}<button className="btn btn-ghost btn-sm" onClick={onEdit}>{I.edit}</button></div>
      </div>
      {med.purpose && <div style={{ fontSize: 13, color: "var(--text-secondary)", marginBottom: 6, fontStyle: "italic" }}>{med.purpose}</div>}
      <div className="card-details">
        {isScheduled && dailyUsage && <span className="card-detail">{I.clock} {dailyUsage}/day</span>}
        {hasCount && <span className="card-detail">{I.pill} {med.currentCount} left</span>}
        {daysLeft !== null && <span className="card-detail" style={{ color: isLow ? "#C0392B" : needsRefill ? "#C77A20" : "inherit" }}>~{daysLeft}d</span>}
      </div>
      {isScheduled && hasCount && dailyUsage > 0 && (
        <div className="supply-bar-container">
          <div className="supply-bar-label"><span>Supply</span><span>{supplyPct}%</span></div>
          <div className="supply-bar"><div className="supply-bar-fill" style={{ width: `${supplyPct}%`, background: barColor }} /></div>
          {refillCheckDate && <div style={{ fontSize: 12, color: "var(--text-muted)", marginTop: 4 }}>{needsRefill ? `‚ö†Ô∏è Refill by ${formatDate(runOutDate)}` : `Refill check: ${formatDate(refillCheckDate)}`}</div>}
        </div>
      )}
      {isScheduled && hasCount && (
        <div style={{ marginTop: 10, display: "flex", gap: 8 }}>
          <button className="btn btn-secondary btn-sm" onClick={() => onUpdateCount(med.id, "refill")}>üíä Refill</button>
          <button className="btn btn-secondary btn-sm" onClick={() => onUpdateCount(med.id, "adjust")}>‚úèÔ∏è Adjust</button>
        </div>
      )}
    </div>
  );
}

// --- Doctor Card (Business Card) -----------------------------
function DoctorCard({ doctor, appointments, people, onEdit, onDelete }) {
  const drAppts = appointments.filter((a) => a.doctorId === doctor.id);
  const assignedPeople = (doctor.personIds || []).map((pid) => people.find((p) => p.id === pid)).filter(Boolean);
  // Per-person summaries
  const personSummaries = useMemo(() => {
    const map = {};
    drAppts.forEach((a) => {
      if (!map[a.personId]) map[a.personId] = { lastCompleted: null, nextScheduled: null };
      if (a.status === "completed" && (!map[a.personId].lastCompleted || a.date > map[a.personId].lastCompleted))
        map[a.personId].lastCompleted = a.date;
      if (a.status === "scheduled" && (!map[a.personId].nextScheduled || a.date < map[a.personId].nextScheduled))
        map[a.personId].nextScheduled = a.date;
    });
    return map;
  }, [drAppts]);

  return (
    <div className="dr-card">
      <div className="card-header" style={{ marginBottom: 4 }}>
        <div>
          <div className="dr-name">{doctor.name}</div>
          {doctor.specialty && <div className="dr-specialty">{doctor.specialty}</div>}
          {doctor.clinic && <div className="dr-clinic">{doctor.clinic}</div>}
        </div>
        <div className="card-actions">
          <button className="btn btn-ghost btn-sm" onClick={onEdit}>{I.edit}</button>
          <button className="btn btn-ghost btn-sm" style={{ color: "#C0392B" }} onClick={onDelete}>{I.trash}</button>
        </div>
      </div>
      {assignedPeople.length > 0 && (
        <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 8, marginTop: 4 }}>
          {assignedPeople.map((p) => (
            <span key={p.id} style={{ display: "inline-flex", alignItems: "center", gap: 4, padding: "3px 10px", borderRadius: 20, background: "#FFF0E8", border: "1px solid var(--peach-mid)", fontSize: 12, fontWeight: 600, color: "var(--coral-deep)" }}>
              {I.people} {p.name}
            </span>
          ))}
        </div>
      )}
      <div className="dr-info">
        {doctor.phone && <div className="dr-info-row">{I.phone} {doctor.phone}</div>}
        {doctor.fax && <div className="dr-info-row">{I.fax} {doctor.fax}</div>}
        {doctor.email && <div className="dr-info-row">{I.mail} {doctor.email}</div>}
        {doctor.address && <div className="dr-info-row">{I.map} {doctor.address}</div>}
      </div>
      {doctor.notes && <div style={{ fontSize: 13, color: "var(--text-muted)", marginTop: 8, fontStyle: "italic" }}>{doctor.notes}</div>}
      {Object.keys(personSummaries).length > 0 && (
        <div className="dr-appt-summary">
          {Object.entries(personSummaries).map(([pid, s]) => {
            const pName = people.find((p) => p.id === pid)?.name || "Unknown";
            return (
              <div key={pid} style={{ marginBottom: 6 }}>
                <div style={{ fontSize: 13, fontWeight: 700, color: "var(--text-primary)", marginBottom: 2 }}>{pName}</div>
                <div className="dr-appt-line"><span>Last visit:</span><strong>{s.lastCompleted ? formatDate(s.lastCompleted) : "None"}</strong></div>
                <div className="dr-appt-line"><span>Next appt:</span><strong>{s.nextScheduled ? formatDate(s.nextScheduled) : "None scheduled"}</strong></div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

// --- Appointment Card ----------------------------------------
function ApptCard({ appt, personName, doctorName, onEdit, onUpdateStatus }) {
  const st = getStatusStyle(appt.status);
  const isPastAppt = isPast(appt.date) && appt.status === "scheduled";
  return (
    <div className="card appt-card" style={{ borderLeftColor: st.color }}>
      <div className="card-header">
        <div>
          <div className="card-title" style={{ fontSize: 15 }}>{doctorName}</div>
          <div className="card-subtitle">{personName} ¬∑ {formatDateTime(appt.date, appt.time)}</div>
        </div>
        <div className="card-actions">
          <span className="appt-status-badge" style={{ background: st.bg, color: st.color }}>{st.label}</span>
          <button className="btn btn-ghost btn-sm" onClick={onEdit}>{I.edit}</button>
        </div>
      </div>
      {appt.reason && <div style={{ fontSize: 13, color: "var(--text-secondary)" }}>{appt.reason}</div>}
      {appt.notes && <div style={{ fontSize: 12, color: "var(--text-muted)", marginTop: 4, fontStyle: "italic" }}>{appt.notes}</div>}
      {isPastAppt && (
        <div style={{ marginTop: 8 }}>
          <button className="btn btn-secondary btn-sm" onClick={() => onUpdateStatus(appt)}>üîî Update Status</button>
        </div>
      )}
      {appt.status === "waiting_reschedule" && (
        <div style={{ marginTop: 8, fontSize: 12, color: "#C77A20", fontWeight: 600 }}>‚è≥ Waiting to be rescheduled</div>
      )}
    </div>
  );
}

// ===============================================================
// MAIN APP
// ===============================================================
function CareTrack() {
  const [data, setData] = useState(DEFAULT_DATA);
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  const [tab, setTab] = useState("dashboard");

  // Modal states
  const [showPersonForm, setShowPersonForm] = useState(null);
  const [showMedForm, setShowMedForm] = useState(null);
  const [showDoctorForm, setShowDoctorForm] = useState(null);
  const [showApptForm, setShowApptForm] = useState(null);
  const [showCountUpdate, setShowCountUpdate] = useState(null);
  const [showApptUpdate, setShowApptUpdate] = useState(null);
  const [confirmDelete, setConfirmDelete] = useState(null);

  // Filters
  const [filterPerson, setFilterPerson] = useState("all");
  const [apptFilter, setApptFilter] = useState("upcoming"); // upcoming | past | all | needs_update
  const [calMonth, setCalMonth] = useState(() => { const d = new Date(); return { year: d.getFullYear(), month: d.getMonth() }; });
  const [calSelected, setCalSelected] = useState(today());
  const [reminderFilter, setReminderFilter] = useState("all");
  const [rptPerson, setRptPerson] = useState("all");
  const [rptDoctor, setRptDoctor] = useState("all");
  const [rptStatus, setRptStatus] = useState("all");
  const [rptDateFrom, setRptDateFrom] = useState("");
  const [rptDateTo, setRptDateTo] = useState("");

  // Auth listener
  useEffect(() => {
    const unsub = auth.onAuthStateChanged((u) => {
      setUser(u);
      setAuthLoading(false);
    });
    return () => unsub();
  }, []);

  // Load data when user signs in
  useEffect(() => {
    if (!user) { setLoading(false); return; }
    (async () => {
      setLoading(true);
      const saved = await loadData(user.uid);
      if (saved) setData({ ...DEFAULT_DATA, ...saved, dismissed: saved.dismissed || [] });
      else setData(DEFAULT_DATA);
      setLoading(false);
    })();
  }, [user]);

  const save = useCallback(async (newData) => {
    setData(newData);
    if (user) await saveData(newData, user.uid);
  }, [user]);

  const handleSignIn = async () => {
    try { await auth.signInWithPopup(googleProvider); } catch (e) { console.error("Sign in failed", e); }
  };
  const handleSignOut = async () => {
    await auth.signOut();
    setData(DEFAULT_DATA);
  };

  // --- CRUD helpers ------------------------------
  const savePerson = (p) => { const exists = data.people.find((x) => x.id === p.id); save({ ...data, people: exists ? data.people.map((x) => x.id === p.id ? p : x) : [...data.people, p] }); setShowPersonForm(null); };
  const deletePerson = (id) => { save({ ...data, people: data.people.filter((p) => p.id !== id), medications: data.medications.filter((m) => m.personId !== id), appointments: data.appointments.filter((a) => a.personId !== id) }); setConfirmDelete(null); };

  const saveMed = (m) => { const exists = data.medications.find((x) => x.id === m.id); save({ ...data, medications: exists ? data.medications.map((x) => x.id === m.id ? m : x) : [...data.medications, m] }); setShowMedForm(null); setShowCountUpdate(null); };
  const deleteMed = (id) => { save({ ...data, medications: data.medications.filter((m) => m.id !== id) }); setConfirmDelete(null); };

  const saveDoctor = (d) => { const exists = data.doctors.find((x) => x.id === d.id); save({ ...data, doctors: exists ? data.doctors.map((x) => x.id === d.id ? d : x) : [...data.doctors, d] }); setShowDoctorForm(null); };
  const deleteDoctor = (id) => { save({ ...data, doctors: data.doctors.filter((d) => d.id !== id) }); setConfirmDelete(null); };

  const saveAppt = (a) => { const exists = data.appointments.find((x) => x.id === a.id); save({ ...data, appointments: exists ? data.appointments.map((x) => x.id === a.id ? a : x) : [...data.appointments, a] }); setShowApptForm(null); };
  const deleteAppt = (id) => { save({ ...data, appointments: data.appointments.filter((a) => a.id !== id) }); setConfirmDelete(null); };

  // --- Appointment status update handler ---------
  const handleApptAction = (appt, action) => {
    if (action === "completed") {
      saveAppt({ ...appt, status: "completed" });
    } else if (action === "waiting_reschedule") {
      saveAppt({ ...appt, status: "waiting_reschedule" });
    } else if (action === "reschedule_new") {
      saveAppt({ ...appt, status: "canceled" });
      setShowApptForm({ personId: appt.personId, doctorId: appt.doctorId, linkedApptId: appt.id, status: "scheduled", reason: appt.reason });
    } else if (action === "no_show") {
      saveAppt({ ...appt, status: "no_show" });
    }
    setShowApptUpdate(null);
  };

  // --- Computed data -----------------------------
  const personName = (id) => data.people.find((p) => p.id === id)?.name || "Unknown";
  const doctorName = (id) => data.doctors.find((d) => d.id === id)?.name || "Unknown";

  // Dismiss / Snooze
  const dismiss = (key) => save({ ...data, dismissed: [...(data.dismissed || []), { key, at: today(), snooze: null }] });
  const snooze = (key, days) => save({ ...data, dismissed: [...(data.dismissed || []), { key, at: today(), snooze: addDays(today(), days) }] });
  const isDismissed = (key) => { const d = (data.dismissed || []).find((r) => r.key === key); if (!d) return false; if (d.snooze && d.snooze <= today()) return false; return true; };
  const clearDismissed = () => save({ ...data, dismissed: [] });

  // --- UNIFIED REMINDERS -------------------------
  const allReminders = useMemo(() => {
    const L = [];
    // Med refill/low
    data.medications.filter((m) => m.active && m.frequency === "scheduled").forEach((med) => {
      const d = (med.dosePerIntake || 1) * (med.intakesPerDay || 1);
      if (med.currentCount != null && d > 0) {
        const dl = Math.floor(med.currentCount / d);
        const pn = personName(med.personId);
        if (dl <= (med.lowThreshold || 3))
          L.push({ key: `ml-${med.id}`, cat: "medication", sev: "danger", icon: "\uD83D\uDC8A", title: `${med.name} \u2014 Critical`, text: `${pn}: ${dl}d left`, act: { label: "Refill", fn: () => setShowCountUpdate({ med, mode: "refill" }) } });
        else if (dl <= (med.refillBuffer || 7))
          L.push({ key: `mr-${med.id}`, cat: "medication", sev: "warn", icon: "\uD83D\uDC8A", title: `${med.name} \u2014 Refill Soon`, text: `${pn}: ${dl}d left`, act: { label: "Refill", fn: () => setShowCountUpdate({ med, mode: "refill" }) } });
      }
    });
    // As-needed inventory check (weekly)
    data.medications.filter((m) => m.active && m.frequency === "as_needed").forEach((med) => {
      const last = med.lastRefillDate;
      const ds = last ? daysBetween(last, today()) : 999;
      if (ds >= 7)
        L.push({ key: `mi-${med.id}`, cat: "medication", sev: "info", icon: "\uD83D\uDCCB", title: `${med.name} \u2014 Inventory Check`, text: `Weekly check for ${personName(med.personId)}'s PRN med.`, act: { label: "Update", fn: () => setShowCountUpdate({ med, mode: "adjust" }) } });
    });
    // Past scheduled = needs update
    data.appointments.filter((a) => a.status === "scheduled" && isPast(a.date)).forEach((a) => {
      L.push({ key: `au-${a.id}`, cat: "appointment", sev: "warn", icon: "\uD83D\uDCC5", title: "Needs Update", text: `${personName(a.personId)} \xB7 ${doctorName(a.doctorId)} \xB7 ${formatDateShort(a.date)}`, act: { label: "Update", fn: () => setShowApptUpdate(a) } });
    });
    // Waiting to reschedule
    data.appointments.filter((a) => a.status === "waiting_reschedule").forEach((a) => {
      L.push({ key: `ar-${a.id}`, cat: "appointment", sev: "warn", icon: "\uD83D\uDD04", title: "Reschedule Needed", text: `${personName(a.personId)} \xB7 ${doctorName(a.doctorId)}`, act: { label: "Schedule", fn: () => setShowApptForm({ personId: a.personId, doctorId: a.doctorId, linkedApptId: a.id, status: "scheduled" }) } });
    });
    // Upcoming within 3 days
    data.appointments.filter((a) => a.status === "scheduled" && !isPast(a.date)).forEach((a) => {
      const d = daysBetween(today(), a.date);
      if (d <= 3 && d >= 0)
        L.push({ key: `as-${a.id}`, cat: "appointment", sev: "info", icon: "\u23F0", title: d === 0 ? "Today!" : d === 1 ? "Tomorrow" : `In ${d} days`, text: `${personName(a.personId)} \xB7 ${doctorName(a.doctorId)}${a.time ? ` at ${a.time}` : ""}` });
    });
    // Annual
    const pairs = new Set();
    data.appointments.forEach((a) => pairs.add(`${a.doctorId}|${a.personId}`));
    pairs.forEach((k) => { const [did, pid] = k.split("|");
      const ap = data.appointments.filter((a) => a.doctorId === did && a.personId === pid);
      const lc = ap.filter((a) => a.status === "completed").sort((a, b) => b.date.localeCompare(a.date))[0];
      if (lc && !ap.some((a) => a.status === "scheduled" && !isPast(a.date))) {
        const ds = daysBetween(lc.date, today());
        if (ds >= 365)
          L.push({ key: `an-${did}-${pid}`, cat: "annual", sev: "annual", icon: "\uD83D\uDCC6", title: "Annual Visit Due", text: `${Math.floor(ds / 30)}mo since ${personName(pid)} saw ${doctorName(did)}`, act: { label: "Book", fn: () => setShowApptForm({ personId: pid, doctorId: did, status: "scheduled" }) } });
      }
    });
    return L.sort((a, b) => ({ danger: 0, warn: 1, annual: 2, info: 3 }[a.sev] || 3) - ({ danger: 0, warn: 1, annual: 2, info: 3 }[b.sev] || 3));
  }, [data]);

  const activeReminders = allReminders.filter((r) => !isDismissed(r.key));
  const filteredReminders = reminderFilter === "all" ? activeReminders : activeReminders.filter((r) => r.cat === reminderFilter);
  const rCounts = useMemo(() => ({ medication: activeReminders.filter((r) => r.cat === "medication").length, appointment: activeReminders.filter((r) => r.cat === "appointment").length, annual: activeReminders.filter((r) => r.cat === "annual").length }), [activeReminders]);

  // --- REPORT DATA -------------------------------
  const reportData = useMemo(() => {
    let ap = [...data.appointments];
    if (rptPerson !== "all") ap = ap.filter((a) => a.personId === rptPerson);
    if (rptDoctor !== "all") ap = ap.filter((a) => a.doctorId === rptDoctor);
    if (rptStatus !== "all") ap = ap.filter((a) => a.status === rptStatus);
    if (rptDateFrom) ap = ap.filter((a) => a.date >= rptDateFrom);
    if (rptDateTo) ap = ap.filter((a) => a.date <= rptDateTo);
    ap.sort((a, b) => a.date.localeCompare(b.date));
    const counts = {}; APPT_STATUSES.forEach((s) => counts[s.value] = 0); ap.forEach((a) => { if (counts[a.status] !== undefined) counts[a.status]++; });
    return { appts: ap, counts, upcoming: ap.filter((a) => a.status === "scheduled" && !isPast(a.date)).length, needsUp: ap.filter((a) => a.status === "scheduled" && isPast(a.date)).length, total: ap.length, grouped: groupBy(ap, (a) => a.date) };
  }, [data, rptPerson, rptDoctor, rptStatus, rptDateFrom, rptDateTo]);

  // (medAlerts/apptAlerts kept for backward compat with nav badges)

  // Med alerts
  const medAlerts = useMemo(() => {
    const list = [];
    data.medications.filter((m) => m.active && m.frequency === "scheduled").forEach((med) => {
      const daily = (med.dosePerIntake || 1) * (med.intakesPerDay || 1);
      if (med.currentCount != null && daily > 0) {
        const daysLeft = Math.floor(med.currentCount / daily);
        const person = data.people.find((p) => p.id === med.personId);
        if (daysLeft <= (med.lowThreshold || 3))
          list.push({ severity: "danger", type: "med", title: `${med.name} ‚Äî Critical!`, text: `${person?.name} has only ${daysLeft}d of supply left.`, id: med.id });
        else if (daysLeft <= (med.refillBuffer || 7))
          list.push({ severity: "warn", type: "med", title: `${med.name} ‚Äî Refill Soon`, text: `${person?.name} should refill within ${daysLeft} days.`, id: med.id });
      }
    });
    return list;
  }, [data]);

  // Appointment alerts: past scheduled = needs update
  const apptAlerts = useMemo(() => {
    return data.appointments
      .filter((a) => a.status === "scheduled" && isPast(a.date))
      .map((a) => ({
        severity: "warn", type: "appt", title: "Appointment Needs Update",
        text: `${personName(a.personId)} with ${doctorName(a.doctorId)} on ${formatDate(a.date)}`,
        appt: a
      }));
  }, [data]);

  // Annual reminders: >365 days since last completed, no future scheduled
  const annualAlerts = useMemo(() => {
    const list = [];
    const doctorPersonPairs = new Set();
    data.appointments.forEach((a) => doctorPersonPairs.add(`${a.doctorId}|${a.personId}`));
    doctorPersonPairs.forEach((key) => {
      const [did, pid] = key.split("|");
      const appts = data.appointments.filter((a) => a.doctorId === did && a.personId === pid);
      const lastCompleted = appts.filter((a) => a.status === "completed").sort((a, b) => b.date.localeCompare(a.date))[0];
      const hasFuture = appts.some((a) => a.status === "scheduled" && !isPast(a.date));
      if (!hasFuture && lastCompleted) {
        const daysSince = daysBetween(lastCompleted.date, today());
        if (daysSince >= 365) {
          list.push({
            severity: "info", type: "annual",
            title: "Annual Visit Reminder",
            text: `It's been ${Math.floor(daysSince / 30)} months since ${personName(pid)} saw ${doctorName(did)}. Consider booking a visit.`,
            doctorId: did, personId: pid
          });
        }
      }
    });
    return list;
  }, [data]);

  // Waiting to reschedule reminders
  const rescheduleAlerts = useMemo(() => {
    return data.appointments
      .filter((a) => a.status === "waiting_reschedule")
      .map((a) => ({
        severity: "warn", type: "reschedule",
        title: "Needs Rescheduling",
        text: `${personName(a.personId)} with ${doctorName(a.doctorId)} ‚Äî still waiting to be rescheduled.`,
        appt: a
      }));
  }, [data]);

  const allAlerts = [...medAlerts, ...apptAlerts, ...rescheduleAlerts, ...annualAlerts]
    .sort((a, b) => a.severity === "danger" ? -1 : b.severity === "danger" ? 1 : 0);

  // Filtered appointments
  const filteredAppts = useMemo(() => {
    let list = data.appointments;
    if (filterPerson !== "all") list = list.filter((a) => a.personId === filterPerson);
    if (apptFilter === "upcoming") list = list.filter((a) => a.status === "scheduled" && !isPast(a.date));
    else if (apptFilter === "past") list = list.filter((a) => a.status === "completed" || isPast(a.date));
    else if (apptFilter === "needs_update") list = list.filter((a) => (a.status === "scheduled" && isPast(a.date)) || a.status === "needs_update" || a.status === "waiting_reschedule");
    return list.sort((a, b) => {
      if (apptFilter === "past") return b.date.localeCompare(a.date);
      return a.date.localeCompare(b.date);
    });
  }, [data, filterPerson, apptFilter]);

  const filteredMeds = filterPerson === "all" ? data.medications : data.medications.filter((m) => m.personId === filterPerson);

  // --- CALENDAR DATA -----------------------------
  const calData = useMemo(() => {
    const { year, month } = calMonth;
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDow = firstDay.getDay();
    const daysInMonth = lastDay.getDate();
    const monthStr = firstDay.toLocaleDateString("en-US", { month: "long", year: "numeric" });

    // Build day cells including padding from prev/next month
    const days = [];
    const prevMonthLast = new Date(year, month, 0).getDate();
    for (let i = startDow - 1; i >= 0; i--) {
      const d = new Date(year, month - 1, prevMonthLast - i);
      days.push({ date: d.toISOString().slice(0, 10), num: prevMonthLast - i, other: true });
    }
    for (let i = 1; i <= daysInMonth; i++) {
      const d = new Date(year, month, i);
      days.push({ date: d.toISOString().slice(0, 10), num: i, other: false });
    }
    const remaining = 7 - (days.length % 7);
    if (remaining < 7) for (let i = 1; i <= remaining; i++) {
      const d = new Date(year, month + 1, i);
      days.push({ date: d.toISOString().slice(0, 10), num: i, other: true });
    }

    // Events per day: appointments + med refill dates
    const events = {};
    const monthStart = `${year}-${String(month + 1).padStart(2, "0")}-01`;
    const monthEnd = `${year}-${String(month + 1).padStart(2, "0")}-${String(daysInMonth).padStart(2, "0")}`;

    data.appointments.filter((a) => a.date >= monthStart && a.date <= monthEnd && a.status !== "canceled").forEach((a) => {
      if (!events[a.date]) events[a.date] = [];
      events[a.date].push({ type: "appt", color: getStatusStyle(a.status).color, label: `${doctorName(a.doctorId)}`, sub: personName(a.personId), time: a.time, status: a.status, id: a.id, appt: a });
    });
    data.medications.filter((m) => m.active && m.frequency === "scheduled").forEach((med) => {
      const daily = (med.dosePerIntake || 1) * (med.intakesPerDay || 1);
      if (med.currentCount != null && daily > 0) {
        const daysLeft = Math.floor(med.currentCount / daily);
        const refillDate = addDays(today(), daysLeft - (med.refillBuffer || 7));
        const runOutDate = addDays(today(), daysLeft);
        if (refillDate >= monthStart && refillDate <= monthEnd) {
          if (!events[refillDate]) events[refillDate] = [];
          events[refillDate].push({ type: "refill", color: daysLeft <= (med.lowThreshold || 3) ? "#C0392B" : "#C77A20", label: `Refill: ${med.name}`, sub: personName(med.personId), med });
        }
        if (runOutDate >= monthStart && runOutDate <= monthEnd && runOutDate !== refillDate) {
          if (!events[runOutDate]) events[runOutDate] = [];
          events[runOutDate].push({ type: "runout", color: "#C0392B", label: `Runs out: ${med.name}`, sub: personName(med.personId), med });
        }
      }
    });
    return { days, events, monthStr };
  }, [calMonth, data]);

  const prevMonth = () => setCalMonth((m) => m.month === 0 ? { year: m.year - 1, month: 11 } : { year: m.year, month: m.month - 1 });
  const nextMonth = () => setCalMonth((m) => m.month === 11 ? { year: m.year + 1, month: 0 } : { year: m.year, month: m.month + 1 });
  const goToday = () => { const d = new Date(); setCalMonth({ year: d.getFullYear(), month: d.getMonth() }); setCalSelected(today()); };
  const selectedEvents = calData.events[calSelected] || [];

  if (authLoading || loading) return (
    <div className="app" style={{ display: "flex", alignItems: "center", justifyContent: "center", height: "100vh" }}>
      <div style={{ textAlign: "center" }}><div style={{ color: "var(--coral)", opacity: 0.7, fontSize: 40, marginBottom: 12 }}>{I.heart}</div><div style={{ fontFamily: "'Lora',serif", fontSize: 18 }}>Loading CareTrack...</div></div>
    </div>
  );

  if (!user) return (
    <div className="app">
      <style>{STYLES}</style>
      <div className="login-screen">
        <div style={{ color: "var(--coral)", opacity: 0.8, marginBottom: 20 }}><svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg></div>
        <div className="login-title">CareTrack</div>
        <div className="login-sub">Medication & Care Manager</div>
        <button className="login-btn" onClick={handleSignIn}>
          <svg width="20" height="20" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
          Sign in with Google
        </button>
        <div style={{ marginTop: 24, fontSize: 13, color: "var(--text-muted)", maxWidth: 280 }}>Your data syncs across all your devices. Sign in to get started.</div>
      </div>
    </div>
  );

  return (
    <div className="app">
      <style>{STYLES}</style>

      {/* User bar */}
      <div className="user-bar">
        <div className="user-bar-info">
          {user.photoURL && <img className="user-avatar" src={user.photoURL} alt="" />}
          <span>{user.displayName || user.email}</span>
        </div>
        <button className="btn btn-ghost btn-xs" onClick={handleSignOut}>Sign out</button>
      </div>

      {/* Header */}
      <div className="header">
        <div className="header-top">
          <div><h1>CareTrack</h1><div className="header-subtitle">Medication & Care Manager</div></div>
          <button className="header-bell" onClick={() => setTab("reminders")}>
            {I.bell}
            {activeReminders.length > 0 && <span className="header-bell-badge">{activeReminders.length}</span>}
          </button>
        </div>
      </div>

      {/* Nav */}
      <div className="nav-tabs">
        <button className={`nav-tab ${tab === "dashboard" ? "active" : ""}`} onClick={() => setTab("dashboard")}>{I.home} Home</button>
        <button className={`nav-tab ${tab === "meds" ? "active" : ""}`} onClick={() => setTab("meds")}>
          {I.pill} Meds{activeReminders.filter((r) => r.cat === "medication" && r.sev === "danger").length > 0 && <span className="nav-badge">{activeReminders.filter((r) => r.cat === "medication" && r.sev === "danger").length}</span>}
        </button>
        <button className={`nav-tab ${tab === "appts" ? "active" : ""}`} onClick={() => setTab("appts")}>
          {I.calendar} Appts{apptAlerts.length > 0 && <span className="nav-badge">{apptAlerts.length}</span>}
        </button>
        <button className={`nav-tab ${tab === "doctors" ? "active" : ""}`} onClick={() => setTab("doctors")}>{I.doctor} Docs</button>
        <button className={`nav-tab ${tab === "people" ? "active" : ""}`} onClick={() => setTab("people")}>{I.people} People</button>
        <button className={`nav-tab ${tab === "reports" ? "active" : ""}`} onClick={() => setTab("reports")}>{I.report} Reports</button>
      </div>

      <div className="content">

        {/* === DASHBOARD ‚Äî Calendar View === */}
        {tab === "dashboard" && (<>
          {data.people.length === 0 ? (
            <div className="empty-state">
              <div className="empty-icon" style={{ transform: "scale(1.2)" }}>{I.heart}</div>
              <div className="empty-title">Welcome to CareTrack</div>
              <div className="empty-text">Start by adding the people you care for, then add their medications and doctors.</div>
              <button className="btn btn-primary" onClick={() => { setTab("people"); setShowPersonForm(false); }}>{I.plus} Add First Person</button>
            </div>
          ) : (<>
            {/* Calendar header */}
            <div className="cal-header">
              <div className="cal-title">{calData.monthStr}</div>
              <div className="cal-nav">
                <button onClick={prevMonth}>{"\u2039"}</button>
                <button onClick={goToday} style={{ fontSize: 12, width: "auto", padding: "0 10px", borderRadius: 16 }}>Today</button>
                <button onClick={nextMonth}>{"\u203A"}</button>
              </div>
            </div>

            {/* Day-of-week headers */}
            <div className="cal-grid">
              {["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((d) => <div className="cal-dow" key={d}>{d}</div>)}
              {calData.days.map((day, i) => {
                const evts = calData.events[day.date] || [];
                const isToday = day.date === today();
                const isSel = day.date === calSelected;
                return (
                  <div key={i} className={`cal-day${day.other ? " other-month" : ""}${isToday ? " today" : ""}${isSel ? " selected" : ""}`} onClick={() => !day.other && setCalSelected(day.date)}>
                    <div className="cal-day-num">{day.num}</div>
                    <div className="cal-dots">
                      {evts.slice(0, 4).map((e, j) => <div key={j} className="cal-dot" style={{ background: e.color }} />)}
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Selected day detail */}
            <div className="cal-day-detail">
              <div className="section-header">
                <span className="section-title">{calSelected === today() ? "Today" : formatDate(calSelected)}</span>
                <span className="section-count">{selectedEvents.length} event{selectedEvents.length !== 1 ? "s" : ""}</span>
              </div>

              {selectedEvents.length === 0 ? (
                <div style={{ textAlign: "center", padding: "20px 0", color: "var(--text-muted)", fontSize: 14 }}>Nothing scheduled for this day</div>
              ) : selectedEvents.map((e, i) => {
                if (e.type === "appt") {
                  const st = getStatusStyle(e.status);
                  return (
                    <div className="card appt-card" key={i} style={{ borderLeftColor: st.color, cursor: "pointer" }} onClick={() => setShowApptForm(e.appt)}>
                      <div className="card-header">
                        <div>
                          <div className="card-title" style={{ fontSize: 14 }}>{e.label}</div>
                          <div className="card-subtitle">{e.sub}{e.time ? ` \xB7 ${e.time}` : ""}</div>
                        </div>
                        <span className="card-badge" style={{ background: st.bg, color: st.color }}>{st.label}</span>
                      </div>
                      {e.appt.reason && <div style={{ fontSize: 12, color: "var(--text-secondary)" }}>{e.appt.reason}</div>}
                    </div>
                  );
                } else {
                  const isRunout = e.type === "runout";
                  return (
                    <div className="card" key={i} style={{ borderLeft: `4px solid ${e.color}`, paddingLeft: 14, cursor: "pointer" }} onClick={() => e.med && setShowCountUpdate({ med: e.med, mode: "refill" })}>
                      <div className="card-header">
                        <div>
                          <div className="card-title" style={{ fontSize: 14 }}>{e.label}</div>
                          <div className="card-subtitle">{e.sub}</div>
                        </div>
                        <span className="card-badge" style={{ background: isRunout ? "#FEECEC" : "#FFF3E0", color: e.color }}>{isRunout ? "Runs Out" : "Refill Due"}</span>
                      </div>
                    </div>
                  );
                }
              })}
            </div>

            {/* Quick stats */}
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 8, marginTop: 16 }}>
              {[
                { n: data.medications.filter((m) => m.active).length, l: "Active Meds", c: "var(--sage-deep)" },
                { n: data.appointments.filter((a) => a.status === "scheduled" && !isPast(a.date)).length, l: "Upcoming", c: "var(--sky-deep)" },
                { n: data.doctors.length, l: "Doctors", c: "var(--amber-deep)" },
              ].map((s, i) => (
                <div className="card" key={i} style={{ textAlign: "center", padding: 10 }}>
                  <div style={{ fontSize: 22, fontWeight: 800, color: s.c }}>{s.n}</div>
                  <div style={{ fontSize: 10, color: "var(--text-muted)", fontWeight: 600 }}>{s.l}</div>
                </div>
              ))}
            </div>
          </>)}
        </>)}

        {/* === MEDICATIONS === */}
        {tab === "meds" && (<>
          {data.people.length === 0 ? (
            <div className="empty-state"><div className="empty-icon">{I.people}</div><div className="empty-title">Add a person first</div><div className="empty-text">You need at least one person before adding medications.</div><button className="btn btn-primary" onClick={() => { setTab("people"); setShowPersonForm(false); }}>{I.plus} Add Person</button></div>
          ) : (<>
            {data.people.length > 1 && <div className="person-pills"><button className={`person-pill ${filterPerson === "all" ? "active" : ""}`} onClick={() => setFilterPerson("all")}>All</button>{data.people.map((p) => <button key={p.id} className={`person-pill ${filterPerson === p.id ? "active" : ""}`} onClick={() => setFilterPerson(p.id)}>{p.name}</button>)}</div>}
            <div className="section-header"><span className="section-title">Medications</span><span className="section-count">{filteredMeds.length} total</span></div>
            {filteredMeds.length === 0 ? <div className="empty-state"><div className="empty-icon">{I.pill}</div><div className="empty-title">No medications</div><div className="empty-text">Tap + to add a medication.</div></div> :
              filteredMeds.map((med) => <MedCard key={med.id} med={med} personName={personName(med.personId)} onEdit={() => setShowMedForm(med)} onUpdateCount={(id, mode) => setShowCountUpdate({ med, mode })} />)}
            <button className="fab" onClick={() => setShowMedForm(false)}>{I.plus}</button>
          </>)}
        </>)}

        {/* === DOCTORS === */}
        {tab === "doctors" && (<>
          <div className="section-header"><span className="section-title">Doctor Directory</span><span className="section-count">{data.doctors.length}</span></div>
          {data.doctors.length === 0 ? (
            <div className="empty-state"><div className="empty-icon">{I.doctor}</div><div className="empty-title">No doctors yet</div><div className="empty-text">Add doctors to track appointments and prescriptions.</div></div>
          ) : (
            data.doctors.map((doc) => <DoctorCard key={doc.id} doctor={doc} appointments={data.appointments} people={data.people} onEdit={() => setShowDoctorForm(doc)} onDelete={() => setConfirmDelete({ type: "doctor", id: doc.id, name: doc.name })} />)
          )}
          <button className="fab" onClick={() => setShowDoctorForm(false)}>{I.plus}</button>
        </>)}

        {/* === APPOINTMENTS === */}
        {tab === "appts" && (<>
          {data.doctors.length === 0 ? (
            <div className="empty-state"><div className="empty-icon">{I.doctor}</div><div className="empty-title">Add a doctor first</div><div className="empty-text">You need at least one doctor before scheduling appointments.</div><button className="btn btn-primary" onClick={() => { setTab("doctors"); setShowDoctorForm(false); }}>{I.plus} Add Doctor</button></div>
          ) : (<>
            {data.people.length > 1 && <div className="person-pills"><button className={`person-pill ${filterPerson === "all" ? "active" : ""}`} onClick={() => setFilterPerson("all")}>All</button>{data.people.map((p) => <button key={p.id} className={`person-pill ${filterPerson === p.id ? "active" : ""}`} onClick={() => setFilterPerson(p.id)}>{p.name}</button>)}</div>}

            {/* Status filter */}
            <div className="person-pills">
              {[
                { key: "upcoming", label: "Upcoming" },
                { key: "needs_update", label: `Needs Update${apptAlerts.length ? ` (${apptAlerts.length})` : ""}` },
                { key: "past", label: "Past" },
                { key: "all", label: "All" },
              ].map((f) => (
                <button key={f.key} className={`person-pill ${apptFilter === f.key ? "active" : ""}`} onClick={() => setApptFilter(f.key)}>{f.label}</button>
              ))}
            </div>

            <div className="section-header"><span className="section-title">Appointments</span><span className="section-count">{filteredAppts.length} shown</span></div>
            {filteredAppts.length === 0 ? (
              <div className="empty-state"><div className="empty-icon">{I.calendar}</div><div className="empty-title">No appointments</div><div className="empty-text">{apptFilter === "upcoming" ? "No upcoming appointments. Tap + to schedule one." : "No appointments match this filter."}</div></div>
            ) : (
              filteredAppts.map((a) => <ApptCard key={a.id} appt={a} personName={personName(a.personId)} doctorName={doctorName(a.doctorId)} onEdit={() => setShowApptForm(a)} onUpdateStatus={(ap) => setShowApptUpdate(ap)} />)
            )}
            <button className="fab" onClick={() => setShowApptForm(false)}>{I.plus}</button>
          </>)}
        </>)}

        {/* === REMINDERS === */}
        {tab === "reminders" && (<>
          <div className="section-header"><span className="section-title">Reminder Center</span><span className="section-count">{activeReminders.length} active</span></div>
          <div className="person-pills">
            {[{ k: "all", l: `All (${activeReminders.length})` }, { k: "medication", l: `Meds (${rCounts.medication})` }, { k: "appointment", l: `Appts (${rCounts.appointment})` }, { k: "annual", l: `Annual (${rCounts.annual})` }].map((f) => (
              <button key={f.k} className={`person-pill ${reminderFilter === f.k ? "active" : ""}`} onClick={() => setReminderFilter(f.k)}>{f.l}</button>
            ))}
          </div>
          {(data.dismissed || []).length > 0 && <div style={{ marginBottom: 12, textAlign: "right" }}><button className="btn btn-ghost btn-xs" onClick={clearDismissed}>Reset dismissed ({data.dismissed.length})</button></div>}
          {filteredReminders.length === 0 ? (
            <div className="empty-state"><div className="empty-icon">{I.bell}</div><div className="empty-title">All clear!</div><div className="empty-text">No active reminders.</div></div>
          ) : filteredReminders.map((r) => {
            const cls = r.sev === "danger" ? "r-danger" : r.sev === "warn" ? "r-warn" : r.cat === "annual" ? "r-annual" : r.cat === "medication" ? "r-inventory" : "r-info";
            const tc = r.sev === "danger" ? "#C0392B" : r.sev === "warn" ? "#C77A20" : r.cat === "annual" ? "#8E6BB0" : "var(--text-primary)";
            return (<div className={`reminder-card ${cls}`} key={r.key}>
              <div style={{ fontSize: 20, flexShrink: 0, marginTop: 1 }}>{r.icon}</div>
              <div className="reminder-body">
                <div className="reminder-title" style={{ color: tc }}>{r.title}</div>
                <div className="reminder-text">{r.text}</div>
                <div className="reminder-actions">
                  {r.act && <button className="btn btn-secondary btn-xs" onClick={r.act.fn}>{r.act.label}</button>}
                  <button className="btn btn-ghost btn-xs" onClick={() => snooze(r.key, 7)} title="Snooze 7d">{"\uD83D\uDE34"} 7d</button>
                  <button className="btn btn-ghost btn-xs" onClick={() => dismiss(r.key)} title="Dismiss">{"\u2715"}</button>
                </div>
              </div>
            </div>);
          })}
        </>)}

        {/* === REPORTS === */}
        {tab === "reports" && (<>
          <div className="section-header"><span className="section-title">Reports</span></div>
          <div className="card" style={{ padding: 14, marginBottom: 14 }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: "var(--text-secondary)", marginBottom: 8, textTransform: "uppercase", letterSpacing: 0.5 }}>Filters</div>
            <div className="form-row">
              <div className="form-group" style={{ marginBottom: 8 }}><label className="form-label">Person</label><select className="form-select" style={{ padding: "8px 10px", fontSize: 13 }} value={rptPerson} onChange={(e) => setRptPerson(e.target.value)}><option value="all">All People</option>{data.people.map((p) => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div>
              <div className="form-group" style={{ marginBottom: 8 }}><label className="form-label">Doctor</label><select className="form-select" style={{ padding: "8px 10px", fontSize: 13 }} value={rptDoctor} onChange={(e) => setRptDoctor(e.target.value)}><option value="all">All Doctors</option>{data.doctors.map((d) => <option key={d.id} value={d.id}>{d.name}</option>)}</select></div>
            </div>
            <div className="form-row">
              <div className="form-group" style={{ marginBottom: 8 }}><label className="form-label">Status</label><select className="form-select" style={{ padding: "8px 10px", fontSize: 13 }} value={rptStatus} onChange={(e) => setRptStatus(e.target.value)}><option value="all">All</option>{APPT_STATUSES.map((s) => <option key={s.value} value={s.value}>{s.label}</option>)}</select></div>
              <div className="form-group" style={{ marginBottom: 8 }}><label className="form-label">From</label><input className="form-input" type="date" style={{ padding: "8px 10px", fontSize: 13 }} value={rptDateFrom} onChange={(e) => setRptDateFrom(e.target.value)} /></div>
            </div>
            <div className="form-row">
              <div className="form-group" style={{ marginBottom: 0 }}><label className="form-label">To</label><input className="form-input" type="date" style={{ padding: "8px 10px", fontSize: 13 }} value={rptDateTo} onChange={(e) => setRptDateTo(e.target.value)} /></div>
              <div className="form-group" style={{ marginBottom: 0, display: "flex", alignItems: "flex-end" }}><button className="btn btn-secondary btn-sm btn-full" onClick={() => { setRptPerson("all"); setRptDoctor("all"); setRptStatus("all"); setRptDateFrom(""); setRptDateTo(""); }}>Clear</button></div>
            </div>
          </div>
          <div className="report-summary">
            <div className="report-stat"><div className="report-stat-num" style={{ color: "var(--sky-deep)" }}>{reportData.upcoming}</div><div className="report-stat-label">Upcoming</div></div>
            <div className="report-stat"><div className="report-stat-num" style={{ color: "#8E6BB0" }}>{reportData.needsUp}</div><div className="report-stat-label">Needs Update</div></div>
            <div className="report-stat"><div className="report-stat-num" style={{ color: "var(--sage-deep)" }}>{reportData.counts.completed || 0}</div><div className="report-stat-label">Completed</div></div>
          </div>
          <div style={{ fontSize: 12, color: "var(--text-muted)", marginBottom: 14, textAlign: "center" }}>
            {reportData.total} total &middot; {reportData.counts.canceled || 0} canceled &middot; {reportData.counts.no_show || 0} no-show
          </div>
          {reportData.total === 0 ? <div className="empty-state"><div className="empty-icon">{I.report}</div><div className="empty-title">No results</div><div className="empty-text">Adjust filters to see data.</div></div> :
            Object.entries(reportData.grouped).map(([date, appts]) => (
              <div className="report-group" key={date}>
                <div className="report-group-header"><span>{fmtDate(date)}</span><span style={{ fontSize: 11, color: "var(--text-muted)" }}>{appts.length} appt{appts.length > 1 ? "s" : ""}</span></div>
                {appts.map((a) => { const st = getStatusStyle(a.status); return (
                  <div className="report-row" key={a.id}>
                    <div className="report-row-time">{a.time || "\u2014"}</div>
                    <div className="report-row-info"><div style={{ fontWeight: 600 }}>{personName(a.personId)}</div><div style={{ color: "var(--text-muted)" }}>{doctorName(a.doctorId)}{a.reason ? ` \xB7 ${a.reason}` : ""}</div></div>
                    <div className="report-row-status"><span className="card-badge" style={{ background: st.bg, color: st.color }}>{st.label}</span></div>
                  </div>); })}
              </div>
            ))
          }
        </>)}

        {/* === PEOPLE === */}
        {tab === "people" && (<>
          <div className="section-header"><span className="section-title">People</span><span className="section-count">{data.people.length}</span></div>
          {data.people.length === 0 ? (
            <div className="empty-state"><div className="empty-icon">{I.people}</div><div className="empty-title">No one added yet</div><div className="empty-text">Add the people you're tracking care for.</div></div>
          ) : (
            data.people.map((person) => {
              const meds = data.medications.filter((m) => m.personId === person.id);
              const appts = data.appointments.filter((a) => a.personId === person.id);
              const upcoming = appts.filter((a) => a.status === "scheduled" && !isPast(a.date));
              return (
                <div className="card" key={person.id}>
                  <div className="card-header">
                    <div><div className="card-title">{person.name}</div>{person.relationship && <div className="card-subtitle">{person.relationship}</div>}</div>
                    <div className="card-actions">
                      <button className="btn btn-ghost btn-sm" onClick={() => setShowPersonForm(person)}>{I.edit}</button>
                      <button className="btn btn-ghost btn-sm" style={{ color: "#C0392B" }} onClick={() => setConfirmDelete({ type: "person", id: person.id, name: person.name })}>{I.trash}</button>
                    </div>
                  </div>
                  {person.notes && <div style={{ fontSize: 13, color: "var(--text-secondary)", marginBottom: 4 }}>{person.notes}</div>}
                  <div className="card-details">
                    <span className="card-detail">{I.pill} {meds.filter((m) => m.active).length} meds</span>
                    <span className="card-detail">{I.calendar} {upcoming.length} upcoming</span>
                  </div>
                </div>
              );
            })
          )}
          <button className="fab" onClick={() => setShowPersonForm(false)}>{I.plus}</button>
        </>)}
      </div>

      {/* === MODALS === */}
      {showPersonForm !== null && <PersonForm person={showPersonForm || undefined} onSave={savePerson} onClose={() => setShowPersonForm(null)} />}
      {showMedForm !== null && <MedForm med={showMedForm || undefined} people={data.people} doctors={data.doctors} onSave={saveMed} onClose={() => setShowMedForm(null)} />}
      {showDoctorForm !== null && <DoctorForm doctor={showDoctorForm || undefined} people={data.people} onSave={saveDoctor} onClose={() => setShowDoctorForm(null)} />}
      {showApptForm !== null && <ApptForm appt={showApptForm || undefined} people={data.people} doctors={data.doctors} onSave={saveAppt} onClose={() => setShowApptForm(null)} />}
      {showCountUpdate && <CountModal med={showCountUpdate.med} mode={showCountUpdate.mode} onSave={saveMed} onClose={() => setShowCountUpdate(null)} />}
      {showApptUpdate && <ApptUpdatePrompt appt={showApptUpdate} personName={personName(showApptUpdate.personId)} doctorName={doctorName(showApptUpdate.doctorId)} onAction={(action) => handleApptAction(showApptUpdate, action)} onClose={() => setShowApptUpdate(null)} />}
      {confirmDelete && <Confirm
        title={`Delete ${confirmDelete.name}?`}
        message={confirmDelete.type === "person" ? "This will remove all their medications and appointments." : confirmDelete.type === "doctor" ? "This doctor will be removed from the directory." : "This will be permanently removed."}
        onConfirm={() => { if (confirmDelete.type === "person") deletePerson(confirmDelete.id); else if (confirmDelete.type === "doctor") deleteDoctor(confirmDelete.id); else if (confirmDelete.type === "med") deleteMed(confirmDelete.id); else deleteAppt(confirmDelete.id); }}
        onCancel={() => setConfirmDelete(null)}
      />}
    </div>
  );
}


ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(CareTrack));
  </script>
</body>
</html>